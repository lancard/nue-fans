<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Free Aviation Navigation System</title>

    <link rel="stylesheet" href="bootstrap/bootstrap.min.css">

    <script src="bootstrap/bootstrap.bundle.min.js"></script>
    <script src="geoid.js"></script>
    <script src="leaflet/leaflet.js"></script>
    <script src="leaflet/leaflet.textpath.js"></script>
    <script src="jquery/jquery-3.6.1.min.js"></script>

    <link rel="stylesheet" href="leaflet/leaflet.css" />
    <script>
        // load cordova script in cordova environment
        if ('_cordovaNative' in window) {
            var cordova = document.createElement('script');
            cordova.async = false;
            cordova.src = '/cordova.js';
            document.head.appendChild(cordova);
        }
        else {
            $(function () {
                init();
            });
        }
    </script>
    <style>
        nav {
            height: 60px;
            z-index: 2000;
        }

        .altitude-panel {
            position: absolute;
            width: 180px;
            padding: 10px;
            top: 80px;
            right: 20px;
            z-index: 1000;
            color: white;
            background-color: black;
            border: solid white;
        }
    </style>
</head>

<body class="d-flex flex-column min-vh-100">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#" onclick="location.reload();">FANS</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarColor01"
                aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarColor01">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <div class="nav-link">
                            <div class="input-group">
                                <span class="input-group-text">Track</span>
                                <div class="form-check form-switch form-control">
                                    <input class="form-check-input" type="checkbox" id="trackMyPosition">
                                </div>
                            </div>
                        </div>
                    </li>
                    <li class="nav-item">
                        <div class="nav-link">
                            <div class="input-group">
                                <span class="input-group-text">VATSIM C/S</span>
                                <input type="text" class="form-control" id="vatsimCallsign">
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div id="map" class="flex-grow-1"></div>

    <div class="altitude-panel">
        <div><small>ALT(GPS): <strong><span id="gpsAltitude">0</span></strong> ft</small></div>
        <div><small>ALT(BARO): <strong><span id="barometerAltitude">0</span></strong> ft</small></div>
        <select id="stationQNH" class="form-control-sm form-select-sm m-2">
            <option value="1050">1050 (31.01)</option>
            <option value="1049">1049 (30.98)</option>
            <option value="1048">1048 (30.95)</option>
            <option value="1047">1047 (30.92)</option>
            <option value="1046">1046 (30.89)</option>
            <option value="1045">1045 (30.86)</option>
            <option value="1044">1044 (30.83)</option>
            <option value="1043">1043 (30.80)</option>
            <option value="1042">1042 (30.77)</option>
            <option value="1041">1041 (30.74)</option>
            <option value="1040">1040 (30.71)</option>
            <option value="1039">1039 (30.68)</option>
            <option value="1038">1038 (30.65)</option>
            <option value="1037">1037 (30.62)</option>
            <option value="1036">1036 (30.59)</option>
            <option value="1035">1035 (30.56)</option>
            <option value="1034">1034 (30.53)</option>
            <option value="1033">1033 (30.50)</option>
            <option value="1032">1032 (30.47)</option>
            <option value="1031">1031 (30.45)</option>
            <option value="1030">1030 (30.42)</option>
            <option value="1029">1029 (30.39)</option>
            <option value="1028">1028 (30.36)</option>
            <option value="1027">1027 (30.33)</option>
            <option value="1026">1026 (30.30)</option>
            <option value="1025">1025 (30.27)</option>
            <option value="1024">1024 (30.24)</option>
            <option value="1023">1023 (30.21)</option>
            <option value="1022">1022 (30.18)</option>
            <option value="1021">1021 (30.15)</option>
            <option value="1020">1020 (30.12)</option>
            <option value="1019">1019 (30.09)</option>
            <option value="1018">1018 (30.06)</option>
            <option value="1017">1017 (30.03)</option>
            <option value="1016">1016 (30.00)</option>
            <option value="1015">1015 (29.97)</option>
            <option value="1014">1014 (29.94)</option>
            <option value="1013" selected>1013 (29.91)</option>
            <option value="1012">1012 (29.88)</option>
            <option value="1011">1011 (29.85)</option>
            <option value="1010">1010 (29.83)</option>
            <option value="1009">1009 (29.80)</option>
            <option value="1008">1008 (29.77)</option>
            <option value="1007">1007 (29.74)</option>
            <option value="1006">1006 (29.71)</option>
            <option value="1005">1005 (29.68)</option>
            <option value="1004">1004 (29.65)</option>
            <option value="1003">1003 (29.62)</option>
            <option value="1002">1002 (29.59)</option>
            <option value="1001">1001 (29.56)</option>
            <option value="1000">1000 (29.53)</option>
            <option value="0999">0999 (29.50)</option>
            <option value="0998">0998 (29.47)</option>
            <option value="0997">0997 (29.44)</option>
            <option value="0996">0996 (29.41)</option>
            <option value="0995">0995 (29.38)</option>
            <option value="0994">0994 (29.35)</option>
            <option value="0993">0993 (29.32)</option>
            <option value="0992">0992 (29.29)</option>
            <option value="0991">0991 (29.26)</option>
            <option value="0990">0990 (29.23)</option>
            <option value="0989">0989 (29.21)</option>
            <option value="0988">0988 (29.18)</option>
            <option value="0987">0987 (29.15)</option>
            <option value="0986">0986 (29.12)</option>
            <option value="0985">0985 (29.09)</option>
            <option value="0984">0984 (29.06)</option>
            <option value="0983">0983 (29.03)</option>
            <option value="0982">0982 (29.00)</option>
            <option value="0981">0981 (28.97)</option>
            <option value="0980">0980 (28.94)</option>
            <option value="0979">0979 (28.91)</option>
            <option value="0978">0978 (28.88)</option>
            <option value="0977">0977 (28.85)</option>
            <option value="0976">0976 (28.82)</option>
            <option value="0975">0975 (28.79)</option>
            <option value="0974">0974 (28.76)</option>
            <option value="0973">0973 (28.73)</option>
            <option value="0972">0972 (28.70)</option>
            <option value="0971">0971 (28.67)</option>
            <option value="0970">0970 (28.64)</option>
            <option value="0969">0969 (28.61)</option>
            <option value="0968">0968 (28.59)</option>
            <option value="0967">0967 (28.56)</option>
            <option value="0966">0966 (28.53)</option>
            <option value="0965">0965 (28.50)</option>
        </select>
    </div>

    <footer class="footer bg-primary mt-auto">
        <div class="container-fluid text-white p-2">
            <span id="status">zoomlevel</span>
        </div>
    </footer>

    <script>
        var map = null;
        var currentLocationPopup = null;
        const maxBounds = L.latLngBounds(L.latLng([38.84978731237103, 123.56280597193731]), L.latLng([33.02870525087617, 132.84627495139412]));
        var gpsAltitude = 0;
        var fixToCoordMap = {};
        var airwayUsedFix = {};

        function getIndicatedAltitude(mb, qnh) {
            return 145366.45 * (Math.pow(qnh / 1013.25, 0.190284) - Math.pow(mb / 1013.25, 0.190284))
        }

        function onSuccess(values) {
            const altitude = getIndicatedAltitude(values, +$("#stationQNH").val());

            $("#barometerAltitude").text(altitude.toFixed(0));
        };

        function onError(error) {
            sensors.disableSensor();
            sensors.enableSensor("PRESSURE");
        };

        document.addEventListener("deviceready", function () {
            init();

            sensors.enableSensor("PRESSURE");

            setInterval(function () { sensors.getState(onSuccess, onError) }, 1000);
        }, false);

        /*
        function demo() {
            var wind = L.polyline([[59.3556, -31.99219], [55.17887, -42.89062], [47.7541, -43.94531], [38.27269, -37.96875], [27.05913, -41.13281], [16.29905, -36.5625], [8.40717, -30.23437], [1.05463, -22.5], [-8.75479, -18.28125], [-21.61658, -20.03906], [-31.35364, -24.25781], [-39.90974, -30.9375], [-43.83453, -41.13281], [-47.7541, -49.92187], [-50.95843, -54.14062], [-55.9738, -56.60156]], {
                weight: 15,
                color: '#8EE9FF'
            }).addTo(map);

            wind.setText(') ', {
                repeat: true,
                offset: 7,
                attributes: {
                    fill: '#007DEF',
                    'font-weight': 'bold',
                    'font-size': '24'
                }
            });

            var danger = L.polyline([[-40.311, -31.952], [-12.086, -18.727]], {
                weight: 10,
                color: 'orange',
                opacity: 0.8
            }).addTo(map);
            danger.setText('\u25BA', {
                repeat: true,
                offset: 6,
                attributes: { fill: 'red' }
            });

            var plane = L.polyline([[-49.38237, -37.26562], [-1.75754, -14.41406], [51.61802, -23.20312]], {
                weight: 1,
                color: 'black',
                dashArray: '2, 2'
            }).addTo(map);
            plane.setText('\u2708     ', {
                repeat: true,
                offset: 8,
                attributes: {
                    'font-weight': 'bold',
                    'font-size': '24'
                }
            });

            var flightsWE = {
                "type": "FeatureCollection",
                "features": [
                    {
                        "type": "Feature",
                        "properties": {
                            "flight": "To New Delhi"
                        },
                        "geometry": {
                            "type": "LineString",
                            "coordinates": [
                                [
                                    3.33984375,
                                    46.6795944656402
                                ],
                                [
                                    29.53125,
                                    46.55886030311719
                                ],
                                [
                                    51.328125,
                                    42.293564192170095
                                ],
                                [
                                    68.5546875,
                                    35.746512259918504
                                ],
                                [
                                    76.81640625,
                                    28.65203063036226
                                ]
                            ]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "flight": "To Hanoi"
                        },
                        "geometry": {
                            "type": "LineString",
                            "coordinates": [
                                [
                                    77.607421875,
                                    28.767659105691255
                                ],
                                [
                                    88.72558593749999,
                                    27.839076094777816
                                ],
                                [
                                    97.3828125,
                                    25.681137335685307
                                ],
                                [
                                    105.77636718749999,
                                    21.248422235627014
                                ]
                            ]
                        }
                    }
                ]
            };

            var flightsEW = {
                "type": "FeatureCollection",
                "features": [
                    {
                        "type": "Feature",
                        "properties": {
                            "flight": "To Bangkok"
                        },
                        "geometry": {
                            "type": "LineString",
                            "coordinates": [
                                [
                                    106.67724609375,
                                    10.790140750321738
                                ],
                                [
                                    104.08447265624999,
                                    11.523087506868514
                                ],
                                [
                                    102.1728515625,
                                    12.254127737657381
                                ],
                                [
                                    100.45898437499999,
                                    13.667338259654947
                                ]
                            ]
                        }
                    }
                ]
            };

            L.geoJson(flightsWE, {
                onEachFeature: function (feature, layer) {
                    layer.setText(feature.properties.flight, { offset: -5 });
                },
                style: {
                    weight: 3,
                    color: 'purple',
                    dashArray: '4, 4'
                }
            }).addTo(map);

            L.geoJson(flightsEW, {
                onEachFeature: function (feature, layer) {
                    layer.setText(feature.properties.flight, { offset: -5, orientation: 'flip' });
                },
                style: {
                    weight: 3,
                    color: 'purple',
                    dashArray: '4, 4'
                }
            }).addTo(map);
        }
        */

        function updatePosition(latitude, longitude, radius) {

            const lagLng = L.latLng([latitude, longitude]);

            if (currentLocationPopup == null) {
                currentLocationPopup = L.circle(lagLng, { radius, color: '#990000', stroke: 'red' })
                    .bindTooltip(`${latitude}<br>${longitude}`, { direction: "bottom", permanent: true })
                    .addTo(map);
            }
            else {
                currentLocationPopup.setLatLng(lagLng).setTooltipContent(`${latitude}\u2708<br>${longitude}`).setRadius(radius);
            }

            if ($("#trackMyPosition").is(':checked')) {
                map.panTo([latitude, longitude], { animate: true });
            }
        }

        function success(position) {
            gpsAltitude = (position.coords.altitude - geoidHeight[`${position.coords.latitude.toFixed(0)}/${position.coords.longitude.toFixed(0)}`]) * 3.28084;

            $("#gpsAltitude").text(gpsAltitude.toFixed(0));

            var callsign = $("#vatsimCallsign").val();

            if (callsign != "")
                return;

            if (map == null)
                return;

            updatePosition(position.coords.latitude, position.coords.longitude, position.coords.accuracy);
        }

        function error(err) {
            $("#status").text(`errA: ${err.code}`);
            // alert(err);
            console.error(`ERROR(${err.code}): ${err.message}`);
        }

        function updateStatusBar() {
            var zoomText = "(just magnified)";

            if(map.getZoom() <= 13) {
                zoomText = "(korea only)";
            }

            if(map.getZoom() <= 7) {
                zoomText = "(whole world)";
            }
            $("#status").text(`zoomlevel: ${map.getZoom()} ${zoomText}`);
        }

        function onZoomEnd(e) {
            updateStatusBar();
        }

        function init() {
            map = L.map('map',
                {
                    center: [37.55748666666666, 126.79195416666667],
                    zoom: 11
                }
            );
            updateStatusBar();

            map.on("zoomend", onZoomEnd);

            // demo();

            L.tileLayer('tiles/{z}/{x}/{y}.png', {
                maxNativeZoom: 13,
                errorTileUrl: 'images/notfound.png',
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            var options = {
                enableHighAccuracy: true,
                timeout: 3000,
                maximumAge: 0
            };

            var id = navigator.geolocation.watchPosition(success, error, options);

            setInterval(updateVatsim, 5000);
        }


        function updateVatsim() {
            var callsign = $("#vatsimCallsign").val();

            if (callsign == "")
                return;

            $.getJSON('../vatsim-data.json', function (ret) {
                ret.pilots.forEach(element => {
                    if (element.callsign != callsign)
                        return;

                    updatePosition(element.latitude, element.longitude, 100);
                    return;
                });
            });
        }
    </script>
</body>

</html>